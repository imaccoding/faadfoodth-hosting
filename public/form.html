<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>‡∏ü‡∏≤‡∏î‡∏ü‡∏π‡πâ‡∏î - ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
  <style>
    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: 'Segoe UI', sans-serif;
      background: #fff8f0;
      color: #333;
      -webkit-tap-highlight-color: transparent;
    }

    header {
      background-color: #ff7043;
      padding: 12px 20px;
      text-align: center;
    }

    header img {
      max-width: 220px;
      height: auto;
    }

    main {
      padding: 20px;
    }

    form {
      background: #fff;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 25px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: auto;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }

    input, select, textarea, button {
      font-size: 16px !important;
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    .productRow {
      margin-top: 20px;
      background: #fff3e0;
      border-radius: 12px;
      padding: 15px;
    }

    .productRow hr {
      border: none;
      border-top: 1px dashed #ccc;
      margin: 15px 0;
    }

    .warning {
      color: #d32f2f;
      font-size: 14px;
    }

    .btn-add, .btn-submit {
      background-color: #fb8c00;
      color: white;
      border: none;
      padding: 14px;
      margin-top: 20px;
      font-size: 18px;
      border-radius: 12px;
      cursor: pointer;
    }

    .btn-remove {
      background-color: #e53935;
      color: white;
      border: none;
      padding: 8px 12px;
      margin-top: 10px;
      border-radius: 8px;
      cursor: pointer;
    }

    #response {
      text-align: center;
      margin-top: 20px;
      font-size: 16px;
      color: #d32f2f;
    }

    #paymentDetails {
      background: #ffe0b2;
      padding: 15px;
      margin-top: 10px;
      border-radius: 10px;
    }

    @media (max-width: 768px) {
      form {
        width: 100%;
        max-width: 100%;
        padding: 16px;
        border-radius: 0;
        box-shadow: none;
      }
    }
  </style>
</head>
<body>
  <main>
    <form id="orderForm">
      <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
      <input type="text" id="name" required>

      <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
      <input type="tel" id="phone" required>

      <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
      <textarea id="address" rows="3" required></textarea>

      <div id="productContainer"></div>
      <button type="button" class="btn-add" onclick="addProductRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£</button>

      <label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label>
      <input type="text" id="total" readonly>

      <label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
      <select id="paymentMethod" onchange="showPaymentDetails()" required>
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á --</option>
        <option value="‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏™‡∏¥‡∏Å‡∏£">‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏™‡∏¥‡∏Å‡∏£</option>
        <option value="‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
        <option value="‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ SCB">‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ SCB</option>
        <option value="‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</option>
        <option value="‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</option>
      </select>

      <div id="paymentDetails"></div>

      <label>‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ</label>
      <input type="file" id="slipImage" accept="image/*">
formData.append("userId", userId); // ‚úÖ ‡∏™‡πà‡∏á userId ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Apps Script

      <button type="button" class="btn-submit" onclick="submitForm()">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>
    </form>
    <div id="response"></div>
  </main>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcLvACn9OWvdTRmukM4vzfLUEBGZ4Nn0bCV9zTgtAHE4g-20W541aHmbJwHpn0uddD/exec";
let productList = [];
let userId = ""; // ‚úÖ Global ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ userId

async function initLiff() {
  try {
    await liff.init({ liffId: "2007253307-JMxPKL5Z" });
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      const profile = await liff.getProfile();
      userId = profile.userId;
    }
  } catch (err) {
    console.error("‚ùå LINE LIFF Error:", err);
  }
}

async function loadProducts() {
  try {
    const res = await fetch(SCRIPT_URL + "?get=products");
    productList = await res.json();
    updateAllSelects();
  } catch (err) {
    document.getElementById("response").innerText = "‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
  }
}

function updateAllSelects() {
  const options = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏´‡∏≤‡∏£ --</option>' +
    productList.map(p => `<option value="${p.name}" data-price="${p.price}" data-stock="${p.stock}">${p.name} - ${p.price}‡∏ø (${p.stock})</option>`).join("");
  document.querySelectorAll("select.product").forEach(sel => {
    const selected = sel.value;
    sel.innerHTML = options;
    sel.value = selected;
  });
}

function addProductRow() {
  const container = document.getElementById("productContainer");
  const row = document.createElement("div");
  row.className = "productRow";
  row.innerHTML = `
    <label>‡πÄ‡∏°‡∏ô‡∏π</label>
    <select class="product" onchange="updatePrice()" required></select>
    <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
    <input type="number" class="quantity" min="1" value="1" onchange="updatePrice()">
    <div class="warning"></div>
    <button type="button" class="btn-remove" onclick="removeProduct(this)">‡∏•‡∏ö</button>
    <hr>
  `;
  container.appendChild(row);
  updateAllSelects();
  updatePrice();
}

function removeProduct(btn) {
  btn.closest(".productRow").remove();
  updatePrice();
}

function updatePrice() {
  let total = 0;
  document.querySelectorAll(".productRow").forEach(row => {
    const select = row.querySelector("select.product");
    const qty = parseInt(row.querySelector("input.quantity").value) || 0;
    const price = parseFloat(select.selectedOptions[0]?.dataset.price || 0);
    const stock = parseInt(select.selectedOptions[0]?.dataset.stock || 0);
    const warning = row.querySelector(".warning");

    if (!select.value) {
      warning.textContent = "";
      return;
    }

    if (qty > stock) {
      warning.textContent = `‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${stock} ‡∏ä‡∏¥‡πâ‡∏ô`;
    } else {
      warning.textContent = "";
      total += qty * price;
    }
  });
  document.getElementById("total").value = total;
}

function showPaymentDetails() {
  const method = document.getElementById("paymentMethod").value;
  const box = document.getElementById("paymentDetails");
  let html = "";

  switch (method) {
    case "‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏™‡∏¥‡∏Å‡∏£":
      html = "<b>‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</b><br>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 123-4-56789-0 <br>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏ã‡πà‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏à‡∏≥‡∏Å‡∏±‡∏î";
      break;
    case "‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û":
      html = "<b>‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</b><br>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 987-6-54321-0 <br>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå";
      break;
    case "‡πÇ‡∏≠‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ SCB":
      html = "<b>‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</b><br>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: 111-2-22222-2 <br>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡πÅ‡∏°‡πà‡∏´‡∏ç‡∏¥‡∏á";
      break;
    case "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå":
      html = "<b>‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</b><br>‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: 0812345678 <br>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡∏≤‡∏á‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å ‡∏£‡∏™‡πÄ‡∏î‡πá‡∏î<br><img src='https://i.imgur.com/YOUR_QR_IMAGE.png' width='150'>";
      break;
    case "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á":
      html = "<b>‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</b> <br>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô";
      break;
  }

  if (method && method !== "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á") {
    html += `<p style='color:#e65100'><strong>üìå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</strong></p>`;
  }

  box.innerHTML = html;
  box.style.display = html ? "block" : "none";
}

async function submitForm() {
  const submitBtn = document.querySelector(".btn-submit");
  const responseBox = document.getElementById("response");
  submitBtn.disabled = true;
  responseBox.innerText = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...";

  const name = document.getElementById("name").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();
  const paymentMethod = document.getElementById("paymentMethod").value;
  const slipFile = document.getElementById("slipImage").files[0];

  let valid = true;

  if (!name || !phone || !address || !paymentMethod) {
    responseBox.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô";
    submitBtn.disabled = false;
    return;
  }

  const phonePattern = /^0[689]\d{8}$/;
  if (!phonePattern.test(phone)) {
    responseBox.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 06, 08 ‡∏´‡∏£‡∏∑‡∏≠ 09)";
    submitBtn.disabled = false;
    return;
  }

  const formData = new FormData();
  formData.append("name", name);
  formData.append("phone", phone);
  formData.append("address", address);
  formData.append("paymentMethod", paymentMethod);
  formData.append("userId", userId); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏™‡πà‡∏á userId ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

  const productRows = document.querySelectorAll(".productRow");
  const selectedProducts = new Set();

  if (productRows.length === 0) {
    responseBox.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
    submitBtn.disabled = false;
    return;
  }

  productRows.forEach(row => {
    const select = row.querySelector("select.product");
    const qty = parseInt(row.querySelector("input.quantity").value);
    const stock = parseInt(select.selectedOptions[0]?.dataset.stock || 0);
    const warning = row.querySelector(".warning");
    const product = select.value;

    if (!product || qty <= 0) {
      warning.textContent = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
      valid = false;
    } else if (qty > stock) {
      warning.textContent = `‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${stock} ‡∏ä‡∏¥‡πâ‡∏ô`;
      valid = false;
    } else if (selectedProducts.has(product)) {
      warning.textContent = "‚ö†Ô∏è ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥";
      valid = false;
    } else {
      warning.textContent = "";
      selectedProducts.add(product);
      formData.append("products[]", product);
      formData.append("quantities[]", qty);
    }
  });

  if (!valid) {
    responseBox.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
    submitBtn.disabled = false;
    return;
  }

  if (paymentMethod !== "‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á" && !slipFile) {
    responseBox.innerText = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô";
    submitBtn.disabled = false;
    return;
  }

  if (slipFile) formData.append("slipImage", slipFile);

  try {
    const res = await fetch(SCRIPT_URL, {
      method: "POST",
      body: formData,
    });

    const json = await res.json();
    console.log("‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å server:", json);

    if (json.status === "success") {
      sessionStorage.setItem("orderData", JSON.stringify(json));
      window.location.href = SCRIPT_URL + `?page=success&orderId=${json.orderId}&total=${json.total}&name=${encodeURIComponent(name)}`;
    } else {
      responseBox.innerText = `‚ùå ${json.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ"}`;
    }

  } catch (err) {
    console.error("üö® ERROR:", err);
    responseBox.innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠";
  }

  submitBtn.disabled = false;
}

// ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
window.addEventListener("DOMContentLoaded", () => {
  loadProducts();
  initLiff();
  setInterval(loadProducts, 5000);
});
</script>

</body>
</html>